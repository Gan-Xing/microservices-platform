# ç”¨æˆ·ç®¡ç†æœåŠ¡å¼€å‘æ–‡æ¡£

## æœåŠ¡å®šä½

é¢å‘**100ç§Ÿæˆ·+10ä¸‡ç”¨æˆ·**çš„ä¼ä¸šçº§ç”Ÿäº§ç³»ç»Ÿè®¾è®¡ï¼Œä½œä¸ºæ•´ä¸ªå¾®æœåŠ¡å¹³å°çš„ç”¨æˆ·æ•°æ®åŸºç¡€ã€‚

### ğŸ¯ æ ‡å‡†ç‰ˆæœ¬å®šä½
- **ç”¨æˆ·è§„æ¨¡**: æ”¯æŒ100ç§Ÿæˆ·+10ä¸‡ç”¨æˆ·ï¼ˆæ¯ç§Ÿæˆ·å¹³å‡1000ç”¨æˆ·ï¼‰
- **APIç«¯ç‚¹**: 57ä¸ªç«¯ç‚¹ï¼Œ10ä¸ªåŠŸèƒ½æ¨¡å—
- **å¤æ‚åº¦**: â­ï¼ˆæœ€ç®€å•æœåŠ¡ï¼Œä¼˜å…ˆå¼€å‘ï¼‰
- **å¼€å‘ä¼˜å…ˆçº§**: Week 1
- **æœåŠ¡ç«¯å£**: 3003

## æŠ€æœ¯é€‰å‹ï¼ˆæœ€ä½³å®è·µï¼‰

### åç«¯æŠ€æœ¯
- **æ¡†æ¶**: NestJS 10.x + TypeScript 5.x
- **æ•°æ®åº“**: PostgreSQL 15+ (å•å®ä¾‹è¶³å¤Ÿ10ä¸‡ç”¨æˆ·)
- **ç¼“å­˜**: Redis 7+ (çƒ­ç‚¹æ•°æ®ç¼“å­˜ï¼Œå¯é€‰)
- **ORM**: Prisma ORM (ç±»å‹å®‰å…¨çš„æ•°æ®è®¿é—®)
- **è®¤è¯**: JWT (æ ‡å‡†è®¤è¯æ–¹æ¡ˆ)
- **éªŒè¯**: Class-validator + Class-transformer
- **åŠ å¯†**: bcrypt (å¯†ç ) + crypto (æ•æ„Ÿæ•°æ®)

### åŸºç¡€è®¾æ–½
- **å®¹å™¨åŒ–**: Docker + Docker Compose (æ¨èï¼Œä¸ä½¿ç”¨K8S)
- **æ¶ˆæ¯é˜Ÿåˆ—**: Redis Streams (æ›¿ä»£Kafka)
- **ç›‘æ§**: Prometheus + Grafana
- **æ—¥å¿—**: Winston + PostgreSQLå­˜å‚¨

## å®Œæ•´åŠŸèƒ½åˆ—è¡¨

### æ ¸å¿ƒåŠŸèƒ½
1. **ç”¨æˆ·æ³¨å†Œ/ç™»å½•/ç™»å‡º**
   - é‚®ç®±/æ‰‹æœºå·æ³¨å†Œ
   - å¯†ç å¼ºåº¦æ ¡éªŒ
   - é˜²é‡å¤æ³¨å†Œ
   - è´¦æˆ·æ¿€æ´»æµç¨‹

2. **ç”¨æˆ·ä¿¡æ¯CRUD**
   - ä¸ªäººèµ„æ–™ç®¡ç†
   - å¤´åƒä¸Šä¼ 
   - æ‰©å±•ä¿¡æ¯ç»´æŠ¤
   - æ•°æ®å¯¼å‡º

3. **å¯†ç ç®¡ç†**
   - å¯†ç ä¿®æ”¹
   - å¯†ç é‡ç½®
   - å¯†ç å¼ºåº¦ç­–ç•¥
   - å¯†ç å†å²è®°å½•

4. **ç”¨æˆ·çŠ¶æ€ç®¡ç†**
   - æ¿€æ´»/ç¦ç”¨
   - æš‚åœ/æ¢å¤
   - åˆ é™¤/æ¢å¤
   - çŠ¶æ€å˜æ›´æ—¥å¿—

### ç”Ÿäº§åŠŸèƒ½
5. **æ‰¹é‡å¯¼å…¥/å¯¼å‡º**
   - Excelæ‰¹é‡å¯¼å…¥
   - CSVæ•°æ®å¯¼å‡º
   - å¯¼å…¥ç»“æœéªŒè¯
   - é”™è¯¯æ•°æ®å¤„ç†

6. **ç”¨æˆ·æœç´¢**
   - PostgreSQLå…¨æ–‡æœç´¢
   - å¤šæ¡ä»¶ç»„åˆæŸ¥è¯¢
   - åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
   - æœç´¢ç»“æœç¼“å­˜

7. **ç™»å½•æ—¥å¿—ä¸å®‰å…¨å®¡è®¡**
   - ç™»å½•è®°å½•è¿½è¸ª
   - å¼‚å¸¸ç™»å½•æ£€æµ‹
   - IPåœ°å€è®°å½•
   - è®¾å¤‡ä¿¡æ¯æ”¶é›†

8. **å¤šå› ç´ è®¤è¯ï¼ˆMFAï¼‰**
   - TOTPéªŒè¯
   - çŸ­ä¿¡éªŒè¯ç 
   - é‚®ç®±éªŒè¯ç 
   - å¤‡ç”¨æ¢å¤ç 

9. **ç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆOAuth2ï¼‰**
   - å¾®ä¿¡ç™»å½•
   - QQç™»å½•
   - GitHubç™»å½•
   - Googleç™»å½•

10. **ç”¨æˆ·åˆ†ç»„ç®¡ç†**
    - ç”¨æˆ·ç»„åˆ›å»º
    - æ‰¹é‡åˆ†ç»„æ“ä½œ
    - ç»„æƒé™ç»§æ‰¿
    - ç»„ç»‡æ¶æ„ç®¡ç†

### æ€§èƒ½ä¼˜åŒ–
- **æ•°æ®åº“ç´¢å¼•ä¼˜åŒ–**
- **çƒ­ç‚¹æ•°æ®Redisç¼“å­˜**
- **åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–**
- **è¿æ¥æ± é…ç½®**

## APIè®¾è®¡ï¼ˆå®Œæ•´ç‰ˆï¼‰

### ç”¨æˆ·ç®¡ç†API
```typescript
// ç”¨æˆ·æ³¨å†Œ
POST /api/v1/users/register
{
  "email": "user@example.com",
  "password": "SecurePassword123!",
  "firstName": "å¼ ",
  "lastName": "ä¸‰",
  "tenantId": "tenant-uuid"
}

// ç”¨æˆ·ç™»å½•
POST /api/v1/users/login
{
  "email": "user@example.com",
  "password": "SecurePassword123!",
  "mfaCode": "123456"
}

// è·å–ç”¨æˆ·ä¿¡æ¯
GET /api/v1/users/profile
Authorization: Bearer {jwt_token}

// æ›´æ–°ç”¨æˆ·ä¿¡æ¯
PUT /api/v1/users/profile
{
  "firstName": "å¼ ",
  "lastName": "ä¸‰",
  "phone": "13800138000",
  "avatar": "https://example.com/avatar.jpg"
}

// ä¿®æ”¹å¯†ç 
POST /api/v1/users/change-password
{
  "currentPassword": "OldPassword123!",
  "newPassword": "NewPassword123!"
}

// é‡ç½®å¯†ç 
POST /api/v1/users/reset-password
{
  "email": "user@example.com"
}

// éªŒè¯é‡ç½®ç 
POST /api/v1/users/verify-reset-code
{
  "email": "user@example.com",
  "code": "123456",
  "newPassword": "NewPassword123!"
}
```

### ç”¨æˆ·ç®¡ç†APIï¼ˆç®¡ç†å‘˜ï¼‰
```typescript
// ç”¨æˆ·åˆ—è¡¨æŸ¥è¯¢
GET /api/v1/admin/users?page=1&limit=20&search=å¼ ä¸‰&status=active

// ç”¨æˆ·è¯¦æƒ…
GET /api/v1/admin/users/{userId}

// æ›´æ–°ç”¨æˆ·çŠ¶æ€
PATCH /api/v1/admin/users/{userId}/status
{
  "status": "suspended",
  "reason": "è¿è§„æ“ä½œ"
}

// æ‰¹é‡å¯¼å…¥ç”¨æˆ·
POST /api/v1/admin/users/batch-import
Content-Type: multipart/form-data
file: users.xlsx

// å¯¼å‡ºç”¨æˆ·æ•°æ®
GET /api/v1/admin/users/export?format=csv&tenantId=xxx

// ç”¨æˆ·åˆ†ç»„ç®¡ç†
POST /api/v1/admin/user-groups
{
  "name": "é”€å”®ç»„",
  "description": "é”€å”®å›¢é˜Ÿæˆå‘˜",
  "userIds": ["user1", "user2"]
}

// ç”¨æˆ·ç™»å½•æ—¥å¿—
GET /api/v1/admin/users/{userId}/login-logs?page=1&limit=10
```

### OAuth2é›†æˆAPI
```typescript
// è·å–ç¬¬ä¸‰æ–¹ç™»å½•URL
GET /api/v1/oauth/authorize/{provider}?redirect_uri=xxx

// ç¬¬ä¸‰æ–¹ç™»å½•å›è°ƒ
POST /api/v1/oauth/callback/{provider}
{
  "code": "auth_code",
  "state": "csrf_token"
}

// ç»‘å®šç¬¬ä¸‰æ–¹è´¦å·
POST /api/v1/users/bind-oauth
{
  "provider": "wechat",
  "openId": "wx_open_id",
  "unionId": "wx_union_id"
}

// è§£ç»‘ç¬¬ä¸‰æ–¹è´¦å·
DELETE /api/v1/users/unbind-oauth/{provider}
```

## æ•°æ®åº“è®¾è®¡

### ç”¨æˆ·ä¸»è¡¨ (users)
```sql
CREATE TABLE users.users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL,
  email VARCHAR(255) UNIQUE NOT NULL,
  phone VARCHAR(20),
  username VARCHAR(50) UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  first_name VARCHAR(100),
  last_name VARCHAR(100),
  avatar_url TEXT,
  status user_status_enum DEFAULT 'active',
  email_verified_at TIMESTAMP,
  phone_verified_at TIMESTAMP,
  last_login_at TIMESTAMP,
  login_count INTEGER DEFAULT 0,
  failed_login_attempts INTEGER DEFAULT 0,
  locked_until TIMESTAMP,
  mfa_enabled BOOLEAN DEFAULT FALSE,
  mfa_secret VARCHAR(32),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  deleted_at TIMESTAMP
);

-- ç”¨æˆ·çŠ¶æ€æšä¸¾
CREATE TYPE user_status_enum AS ENUM ('active', 'inactive', 'suspended', 'banned', 'deleted');
```

### ç”¨æˆ·æ‰©å±•ä¿¡æ¯è¡¨ (user_profiles)
```sql
CREATE TABLE users.user_profiles (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users.users(id) ON DELETE CASCADE,
  gender VARCHAR(10),
  birthday DATE,
  timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
  language VARCHAR(10) DEFAULT 'zh-CN',
  bio TEXT,
  address JSONB,
  social_links JSONB,
  preferences JSONB,
  custom_fields JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

### ç”¨æˆ·ç™»å½•æ—¥å¿—è¡¨ (user_login_logs)
```sql
CREATE TABLE users.user_login_logs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users.users(id) ON DELETE CASCADE,
  tenant_id UUID NOT NULL,
  login_type VARCHAR(20) NOT NULL, -- 'password', 'oauth', 'mfa'
  ip_address INET,
  user_agent TEXT,
  device_info JSONB,
  location JSONB,
  status VARCHAR(20) NOT NULL, -- 'success', 'failed', 'blocked'
  failure_reason VARCHAR(100),
  session_id VARCHAR(255),
  created_at TIMESTAMP DEFAULT NOW()
);
```

### ç¬¬ä¸‰æ–¹è´¦å·ç»‘å®šè¡¨ (user_oauth_accounts)
```sql
CREATE TABLE users.user_oauth_accounts (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users.users(id) ON DELETE CASCADE,
  provider VARCHAR(20) NOT NULL, -- 'wechat', 'qq', 'github', 'google'
  provider_id VARCHAR(100) NOT NULL,
  open_id VARCHAR(100),
  union_id VARCHAR(100),
  access_token TEXT,
  refresh_token TEXT,
  token_expires_at TIMESTAMP,
  profile_data JSONB,
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(provider, provider_id)
);
```

### ç”¨æˆ·åˆ†ç»„è¡¨ (user_groups)
```sql
CREATE TABLE users.user_groups (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL,
  name VARCHAR(100) NOT NULL,
  description TEXT,
  parent_group_id UUID REFERENCES users.user_groups(id),
  created_by UUID REFERENCES users.users(id),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(tenant_id, name)
);

CREATE TABLE users.user_group_members (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  group_id UUID REFERENCES users.user_groups(id) ON DELETE CASCADE,
  user_id UUID REFERENCES users.users(id) ON DELETE CASCADE,
  joined_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(group_id, user_id)
);
```

## ç¼“å­˜ç­–ç•¥

### Redisç¼“å­˜è®¾è®¡
```typescript
// ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆçƒ­ç‚¹æ•°æ®ï¼‰
Cache Key: user:profile:{userId}
TTL: 1å°æ—¶
Data: ç”¨æˆ·åŸºæœ¬ä¿¡æ¯å’Œæ‰©å±•ä¿¡æ¯

// ç”¨æˆ·æƒé™ç¼“å­˜
Cache Key: user:permissions:{userId}
TTL: 30åˆ†é’Ÿ
Data: ç”¨æˆ·æƒé™åˆ—è¡¨

// é‚®ç®±éªŒè¯ç ç¼“å­˜
Cache Key: verify_code:email:{email}
TTL: 5åˆ†é’Ÿ
Data: éªŒè¯ç å’Œé‡è¯•æ¬¡æ•°

// çŸ­ä¿¡éªŒè¯ç ç¼“å­˜
Cache Key: verify_code:sms:{phone}
TTL: 5åˆ†é’Ÿ
Data: éªŒè¯ç å’Œé‡è¯•æ¬¡æ•°

// å¯†ç é‡ç½®Tokenç¼“å­˜
Cache Key: reset_token:{token}
TTL: 1å°æ—¶
Data: ç”¨æˆ·IDå’Œè¿‡æœŸæ—¶é—´

// ç™»å½•å¤±è´¥æ¬¡æ•°ç¼“å­˜
Cache Key: login_attempts:{email}
TTL: 1å°æ—¶
Data: å¤±è´¥æ¬¡æ•°å’Œé”å®šæ—¶é—´
```

## å®‰å…¨æªæ–½

### æ•°æ®ä¿æŠ¤
- **å¯†ç åŠ å¯†**: bcrypt with salt rounds 12
- **æ•æ„Ÿä¿¡æ¯åŠ å¯†**: AES-256-GCM
- **ä¸ªäººä¿¡æ¯è„±æ•**: æ—¥å¿—ä¸­éšè—æ•æ„Ÿä¿¡æ¯
- **SQLæ³¨å…¥é˜²æŠ¤**: Prisma ORMå‚æ•°åŒ–æŸ¥è¯¢
- **XSSé˜²æŠ¤**: è¾“å…¥éªŒè¯å’Œè¾“å‡ºç¼–ç 

### æ¥å£å®‰å…¨
- **JWT TokenéªŒè¯**: RS256ç­¾åç®—æ³•
- **è¯·æ±‚é¢‘ç‡é™åˆ¶**: ç™»å½•æ¥å£é™åˆ¶10æ¬¡/åˆ†é’Ÿ
- **å‚æ•°éªŒè¯**: Class-validatorä¸¥æ ¼éªŒè¯
- **CORSé…ç½®**: é™åˆ¶è·¨åŸŸè®¿é—®
- **HTTPSå¼ºåˆ¶**: ç”Ÿäº§ç¯å¢ƒå¼ºåˆ¶HTTPS

### å¤šå› ç´ è®¤è¯
```typescript
// TOTPé…ç½®
const totpConfig = {
  name: 'Platform',
  keyLength: 32,
  codeLength: 6,
  window: 1,
  encoding: 'base32'
};

// MFAéªŒè¯æµç¨‹
@Post('enable-mfa')
async enableMFA(@CurrentUser() user: User) {
  const secret = authenticator.generateSecret();
  const qrCode = authenticator.keyuri(user.email, 'Platform', secret);
  // è¿”å›äºŒç»´ç ä¾›ç”¨æˆ·æ‰«æ
  return { qrCode, secret };
}
```

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–
```sql
-- å…³é”®ç´¢å¼•
CREATE INDEX idx_users_email ON users.users(email);
CREATE INDEX idx_users_tenant_id ON users.users(tenant_id);
CREATE INDEX idx_users_status ON users.users(status);
CREATE INDEX idx_users_created_at ON users.users(created_at DESC);
CREATE INDEX idx_users_last_login ON users.users(last_login_at DESC);

-- å¤åˆç´¢å¼•
CREATE INDEX idx_users_tenant_status ON users.users(tenant_id, status);
CREATE INDEX idx_users_search ON users.users USING gin(to_tsvector('simple', first_name || ' ' || last_name || ' ' || email));

-- ç™»å½•æ—¥å¿—ç´¢å¼•
CREATE INDEX idx_login_logs_user_time ON users.user_login_logs(user_id, created_at DESC);
CREATE INDEX idx_login_logs_ip ON users.user_login_logs(ip_address, created_at DESC);
```

### æŸ¥è¯¢ä¼˜åŒ–
```typescript
// åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–
async findUsers(query: FindUsersDto): Promise<PaginatedResult<User>> {
  const { page = 1, limit = 20, search, status, tenantId } = query;
  
  const where: Prisma.UserWhereInput = {
    tenantId,
    ...(status && { status }),
    ...(search && {
      OR: [
        { email: { contains: search, mode: 'insensitive' } },
        { firstName: { contains: search, mode: 'insensitive' } },
        { lastName: { contains: search, mode: 'insensitive' } }
      ]
    })
  };

  const [users, total] = await Promise.all([
    this.prisma.user.findMany({
      where,
      skip: (page - 1) * limit,
      take: limit,
      orderBy: { createdAt: 'desc' },
      select: {
        id: true,
        email: true,
        firstName: true,
        lastName: true,
        status: true,
        lastLoginAt: true,
        createdAt: true
      }
    }),
    this.prisma.user.count({ where })
  ]);

  return {
    data: users,
    pagination: {
      page,
      limit,
      total,
      pages: Math.ceil(total / limit)
    }
  };
}
```

## éƒ¨ç½²é…ç½®

### Dockeré…ç½®
```dockerfile
# Dockerfile
FROM node:18-alpine

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .
RUN npm run build

EXPOSE 3003

CMD ["node", "dist/main.js"]
```

### Docker Composeé…ç½®
```yaml
user-service:
  build: ./apps/user-management-service
  ports:
    - "3003:3003"
  environment:
    DATABASE_URL: postgresql://platform:platform123@postgres:5432/platform
    REDIS_URL: redis://redis:6379
    JWT_SECRET: ${JWT_SECRET}
    SMTP_HOST: ${SMTP_HOST}
    SMTP_PORT: ${SMTP_PORT}
    SMTP_USER: ${SMTP_USER}
    SMTP_PASS: ${SMTP_PASS}
    NODE_ENV: production
  depends_on:
    postgres:
      condition: service_healthy
    redis:
      condition: service_healthy
  deploy:
    resources:
      limits:
        memory: 256MB
        cpus: '0.5'
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
    interval: 30s
    timeout: 10s
    retries: 3
```

### ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env
DATABASE_URL=postgresql://platform:platform123@postgres:5432/platform
REDIS_URL=redis://redis:6379
JWT_SECRET=your-super-secret-jwt-key
JWT_EXPIRES_IN=7d
REFRESH_TOKEN_EXPIRES_IN=30d

# SMTPé…ç½®
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=your-email@gmail.com
SMTP_PASS=your-app-password

# OAuthé…ç½®
WECHAT_APP_ID=your-wechat-app-id
WECHAT_APP_SECRET=your-wechat-app-secret
GITHUB_CLIENT_ID=your-github-client-id
GITHUB_CLIENT_SECRET=your-github-client-secret

# æ–‡ä»¶ä¸Šä¼ é…ç½®
UPLOAD_MAX_SIZE=10MB
UPLOAD_ALLOWED_TYPES=jpg,jpeg,png,gif
UPLOAD_STORAGE=local
UPLOAD_PATH=/app/uploads
```

## ç›‘æ§å’Œå‘Šè­¦

### å¥åº·æ£€æŸ¥
```typescript
@Controller('health')
export class HealthController {
  constructor(
    private readonly prisma: PrismaService,
    private readonly redis: RedisService
  ) {}

  @Get()
  async check(): Promise<HealthStatus> {
    const checks = await Promise.allSettled([
      this.checkDatabase(),
      this.checkRedis(),
      this.checkMemory()
    ]);

    return {
      status: checks.every(c => c.status === 'fulfilled') ? 'healthy' : 'unhealthy',
      timestamp: new Date().toISOString(),
      checks: {
        database: checks[0].status === 'fulfilled',
        redis: checks[1].status === 'fulfilled',
        memory: checks[2].status === 'fulfilled'
      }
    };
  }
}
```

### PrometheusæŒ‡æ ‡
```typescript
// metrics.service.ts
@Injectable()
export class MetricsService {
  private readonly userRegistrations = new Counter({
    name: 'user_registrations_total',
    help: 'Total number of user registrations',
    labelNames: ['tenant_id', 'status']
  });

  private readonly userLogins = new Counter({
    name: 'user_logins_total',
    help: 'Total number of user logins',
    labelNames: ['tenant_id', 'method', 'status']
  });

  private readonly activeUsers = new Gauge({
    name: 'active_users_count',
    help: 'Number of active users',
    labelNames: ['tenant_id']
  });

  recordRegistration(tenantId: string, status: 'success' | 'failed') {
    this.userRegistrations.inc({ tenant_id: tenantId, status });
  }

  recordLogin(tenantId: string, method: string, status: 'success' | 'failed') {
    this.userLogins.inc({ tenant_id: tenantId, method, status });
  }
}
```

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
```typescript
// user.service.spec.ts
describe('UserService', () => {
  let service: UserService;
  let prisma: PrismaService;

  beforeEach(async () => {
    const module = await Test.createTestingModule({
      providers: [
        UserService,
        {
          provide: PrismaService,
          useValue: mockPrismaService
        }
      ]
    }).compile();

    service = module.get<UserService>(UserService);
    prisma = module.get<PrismaService>(PrismaService);
  });

  describe('createUser', () => {
    it('should create a new user successfully', async () => {
      const userData = {
        email: 'test@example.com',
        password: 'Password123!',
        firstName: 'å¼ ',
        lastName: 'ä¸‰',
        tenantId: 'tenant-uuid'
      };

      const result = await service.createUser(userData);

      expect(result).toBeDefined();
      expect(result.email).toBe(userData.email);
      expect(result.passwordHash).not.toBe(userData.password);
    });

    it('should throw error for duplicate email', async () => {
      prisma.user.create.mockRejectedValue(new Error('Unique constraint failed'));

      await expect(service.createUser(userData)).rejects.toThrow(ConflictException);
    });
  });
});
```

### é›†æˆæµ‹è¯•
```typescript
// user.controller.e2e-spec.ts
describe('UserController (e2e)', () => {
  let app: INestApplication;
  let prisma: PrismaService;

  beforeAll(async () => {
    const moduleFixture = await Test.createTestingModule({
      imports: [AppModule]
    }).compile();

    app = moduleFixture.createNestApplication();
    prisma = app.get<PrismaService>(PrismaService);
    await app.init();
  });

  describe('/users/register (POST)', () => {
    it('should register a new user', () => {
      return request(app.getHttpServer())
        .post('/users/register')
        .send({
          email: 'test@example.com',
          password: 'Password123!',
          firstName: 'å¼ ',
          lastName: 'ä¸‰',
          tenantId: 'tenant-uuid'
        })
        .expect(201)
        .expect(res => {
          expect(res.body.data.email).toBe('test@example.com');
          expect(res.body.data.passwordHash).toBeUndefined();
        });
    });
  });
});
```

## éƒ¨ç½²æ¸…å•

### ç”Ÿäº§ç¯å¢ƒé…ç½®
- **å†…å­˜éœ€æ±‚**: 256MB
- **CPUéœ€æ±‚**: 0.5 core
- **å¹¶å‘è¿æ¥**: 100
- **æ•°æ®åº“è¿æ¥æ± **: 20
- **Redisè¿æ¥æ± **: 10

### ç›‘æ§æŒ‡æ ‡
- **å“åº”æ—¶é—´**: P95 < 100ms
- **é”™è¯¯ç‡**: < 0.1%
- **å¯ç”¨æ€§**: > 99.9%
- **ååé‡**: 500 QPS

### å‘Šè­¦è§„åˆ™
- **å†…å­˜ä½¿ç”¨ç‡** > 80%
- **CPUä½¿ç”¨ç‡** > 70%
- **å“åº”æ—¶é—´** > 500ms
- **é”™è¯¯ç‡** > 1%
- **æ•°æ®åº“è¿æ¥æ•°** > 80%

**ç”¨æˆ·ç®¡ç†æœåŠ¡ä½œä¸ºæ ‡å‡†ç‰ˆæœ¬çš„åŸºç¡€æœåŠ¡ï¼Œæä¾›å®Œæ•´çš„ç”¨æˆ·ç”Ÿå‘½å‘¨æœŸç®¡ç†åŠŸèƒ½ï¼Œæ”¯æŒ100ç§Ÿæˆ·ã€10ä¸‡ç”¨æˆ·çš„ç”Ÿäº§çº§éœ€æ±‚ï¼** ğŸš€