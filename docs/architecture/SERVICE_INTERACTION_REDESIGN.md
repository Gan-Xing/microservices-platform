# ä¼ä¸šçº§å¾®æœåŠ¡äº¤äº’æ¶æ„é‡è®¾è®¡

## ğŸ¯ è®¾è®¡åŸåˆ™

### 1. æœåŠ¡åˆ†å±‚æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    åº”ç”¨å±‚ (Application Layer)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ APIç½‘å…³æœåŠ¡   â”‚  â”‚ æ–‡ä»¶å­˜å‚¨æœåŠ¡  â”‚  â”‚ ä»»åŠ¡è°ƒåº¦æœåŠ¡  â”‚           â”‚
â”‚  â”‚   (3000)    â”‚  â”‚   (3006)    â”‚  â”‚   (3009)    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ä¸šåŠ¡å±‚ (Business Layer)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ ç”¨æˆ·ç®¡ç†æœåŠ¡  â”‚  â”‚ ç§Ÿæˆ·ç®¡ç†æœåŠ¡  â”‚  â”‚ é€šçŸ¥æœåŠ¡     â”‚           â”‚
â”‚  â”‚   (3003)    â”‚  â”‚   (3004)    â”‚  â”‚   (3005)    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ ¸å¿ƒå±‚ (Core Layer)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ è®¤è¯æˆæƒæœåŠ¡  â”‚  â”‚ æƒé™ç®¡ç†æœåŠ¡  â”‚  â”‚ å®¡è®¡æœåŠ¡     â”‚           â”‚
â”‚  â”‚   (3001)    â”‚  â”‚   (3002)    â”‚  â”‚   (3008)    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åŸºç¡€è®¾æ–½å±‚ (Infrastructure Layer)              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ ç¼“å­˜æœåŠ¡     â”‚  â”‚ æ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡  â”‚  â”‚ ç›‘æ§æœåŠ¡     â”‚           â”‚
â”‚  â”‚   (3011)    â”‚  â”‚   (3010)    â”‚  â”‚   (3007)    â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. è°ƒç”¨æ–¹å‘åŸåˆ™
- **å‘ä¸‹è°ƒç”¨**: ä¸Šå±‚æœåŠ¡åªèƒ½è°ƒç”¨ä¸‹å±‚æœåŠ¡
- **åŒå±‚è°ƒç”¨**: åŒå±‚æœåŠ¡é—´é€šè¿‡äº‹ä»¶æ€»çº¿è¿›è¡Œå¼‚æ­¥é€šä¿¡
- **ç¦æ­¢å‘ä¸Šè°ƒç”¨**: ä¸‹å±‚æœåŠ¡ä¸èƒ½ç›´æ¥è°ƒç”¨ä¸Šå±‚æœåŠ¡ï¼Œåªèƒ½é€šè¿‡äº‹ä»¶é€šçŸ¥

### 3. æ€§èƒ½åˆ†çº§æ ‡å‡†
- **åŸºç¡€è®¾æ–½å±‚**: < 5ms (ç¼“å­˜ã€é˜Ÿåˆ—ã€ç›‘æ§)
- **æ ¸å¿ƒå±‚**: < 20ms (è®¤è¯ã€æƒé™ã€å®¡è®¡)  
- **ä¸šåŠ¡å±‚**: < 50ms (ç”¨æˆ·ã€ç§Ÿæˆ·ã€é€šçŸ¥)
- **åº”ç”¨å±‚**: < 100ms (ç½‘å…³ã€æ–‡ä»¶ã€è°ƒåº¦)

## ğŸ”„ å®Œæ•´ä¸šåŠ¡åœºæ™¯çš„æœåŠ¡äº¤äº’è®¾è®¡

### åœºæ™¯1: ç”¨æˆ·æ³¨å†Œå®Œæ•´æµç¨‹
```typescript
// 1. APIç½‘å…³æ¥æ”¶è¯·æ±‚
POST /api/v1/auth/register
â†“
// 2. ç½‘å…³ â†’ è®¤è¯æœåŠ¡é¢„æ£€æŸ¥
POST http://auth-service:3001/internal/auth/pre-validate
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: { email, tenantId }
â†“
// 3. è®¤è¯æœåŠ¡ â†’ ç§Ÿæˆ·æœåŠ¡éªŒè¯ç§Ÿæˆ·
GET http://tenant-management-service:3004/internal/tenants/{tenantId}/validate
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
â†“
// 4. è®¤è¯æœåŠ¡ â†’ ç”¨æˆ·æœåŠ¡åˆ›å»ºç”¨æˆ·
POST http://user-management-service:3003/internal/users/create
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: { email, password, tenantId, profile }
â†“
// 5. ç”¨æˆ·æœåŠ¡ â†’ RBACæœåŠ¡åˆ†é…é»˜è®¤è§’è‰²
POST http://rbac-service:3002/internal/users/{userId}/assign-default-role
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: { tenantId, userType: "member" }
â†“
// 6. ç”¨æˆ·æœåŠ¡ â†’ æ¶ˆæ¯é˜Ÿåˆ—å‘å¸ƒç”¨æˆ·åˆ›å»ºäº‹ä»¶
POST http://message-queue-service:3010/internal/events/publish
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: {
  eventType: "user.created",
  tenantId,
  userId,
  data: { email, profile }
}
â†“
// 7. é€šçŸ¥æœåŠ¡ç›‘å¬äº‹ä»¶ï¼Œå‘é€æ¬¢è¿é‚®ä»¶
// 8. å®¡è®¡æœåŠ¡ç›‘å¬äº‹ä»¶ï¼Œè®°å½•ç”¨æˆ·åˆ›å»ºæ—¥å¿—
// 9. ç›‘æ§æœåŠ¡ç›‘å¬äº‹ä»¶ï¼Œæ›´æ–°ç”¨æˆ·ç»Ÿè®¡æŒ‡æ ‡
```

### åœºæ™¯2: ç”¨æˆ·ç™»å½•è®¤è¯æµç¨‹
```typescript
// 1. APIç½‘å…³æ¥æ”¶ç™»å½•è¯·æ±‚
POST /api/v1/auth/login
â†“
// 2. ç½‘å…³ â†’ è®¤è¯æœåŠ¡
POST http://auth-service:3001/internal/auth/authenticate
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: { email, password, tenantId }
â†“
// 3. è®¤è¯æœåŠ¡ â†’ ç”¨æˆ·æœåŠ¡éªŒè¯å‡­æ®
POST http://user-management-service:3003/internal/users/validate-credentials
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: { email, password, tenantId }
â†“
// 4. è®¤è¯æœåŠ¡ â†’ RBACæœåŠ¡è·å–ç”¨æˆ·æƒé™
GET http://rbac-service:3002/internal/users/{userId}/permissions
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Query: tenantId={tenantId}
â†“
// 5. è®¤è¯æœåŠ¡ â†’ ç¼“å­˜æœåŠ¡å­˜å‚¨ä¼šè¯
POST http://cache-service:3011/internal/sessions/create
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: {
  sessionId,
  userId,
  tenantId,
  permissions,
  expiresAt
}
â†“
// 6. è®¤è¯æœåŠ¡ â†’ æ¶ˆæ¯é˜Ÿåˆ—å‘å¸ƒç™»å½•äº‹ä»¶
POST http://message-queue-service:3010/internal/events/publish
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: {
  eventType: "auth.login",
  tenantId,
  userId,
  data: { loginTime, ip, userAgent }
}
```

### åœºæ™¯3: æ–‡ä»¶ä¸Šä¼ æƒé™éªŒè¯æµç¨‹
```typescript
// 1. APIç½‘å…³æ¥æ”¶æ–‡ä»¶ä¸Šä¼ è¯·æ±‚
POST /api/v1/files/upload
â†“
// 2. ç½‘å…³ â†’ è®¤è¯æœåŠ¡éªŒè¯Token
POST http://auth-service:3001/internal/auth/verify-token
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: { token: userJwtToken }
â†“
// 3. ç½‘å…³ â†’ æ–‡ä»¶æœåŠ¡
POST http://file-storage-service:3006/internal/files/upload-request
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}, X-User-Context: {userId,tenantId,permissions}
Body: { fileName, fileSize, contentType, folder }
â†“
// 4. æ–‡ä»¶æœåŠ¡ â†’ RBACæœåŠ¡æ£€æŸ¥ä¸Šä¼ æƒé™
POST http://rbac-service:3002/internal/permissions/check
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: {
  userId,
  tenantId,
  resource: "file",
  action: "upload",
  context: { folder, fileSize }
}
â†“
// 5. æ–‡ä»¶æœåŠ¡ â†’ ç§Ÿæˆ·æœåŠ¡æ£€æŸ¥å­˜å‚¨é…é¢
POST http://tenant-management-service:3004/internal/tenants/{tenantId}/check-quota
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: {
  resourceType: "storage",
  requestedAmount: fileSize
}
â†“
// 6. æ–‡ä»¶æœåŠ¡æ‰§è¡Œä¸Šä¼ ï¼Œå‘å¸ƒäº‹ä»¶
POST http://message-queue-service:3010/internal/events/publish
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: {
  eventType: "file.uploaded",
  tenantId,
  userId,
  data: { fileId, fileName, fileSize, folder }
}
```

### åœºæ™¯4: å®šæ—¶ä»»åŠ¡æ‰§è¡Œæµç¨‹
```typescript
// 1. ä»»åŠ¡è°ƒåº¦æœåŠ¡è§¦å‘å®šæ—¶ä»»åŠ¡
Scheduler triggers job execution
â†“
// 2. è°ƒåº¦æœåŠ¡ â†’ è®¤è¯æœåŠ¡è·å–ç³»ç»ŸToken
POST http://auth-service:3001/internal/auth/system-token
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: { serviceId: "scheduler-service", operation: "batch-cleanup" }
â†“
// 3. è°ƒåº¦æœåŠ¡ â†’ ç›®æ ‡ä¸šåŠ¡æœåŠ¡æ‰§è¡Œæ“ä½œ
POST http://file-storage-service:3006/internal/maintenance/cleanup-temp-files
Headers: X-Service-Token: {token}, X-System-Token: {systemToken}, X-Request-ID: {requestId}
Body: { olderThan: "7d" }
â†“
// 4. è°ƒåº¦æœåŠ¡ â†’ ç›‘æ§æœåŠ¡ä¸ŠæŠ¥æ‰§è¡Œç»“æœ
POST http://monitoring-service:3007/internal/jobs/execution-result
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: {
  jobId,
  jobType: "file-cleanup",
  status: "completed",
  duration: 1200,
  processedItems: 150,
  errors: []
}
â†“
// 5. å¦‚æœæ‰§è¡Œå¤±è´¥ â†’ é€šçŸ¥æœåŠ¡å‘é€å‘Šè­¦
POST http://notification-service:3005/internal/alerts/send
Headers: X-Service-Token: {token}, X-Request-ID: {requestId}
Body: {
  alertType: "job_failure",
  severity: "warning",
  jobId,
  message: "File cleanup job failed",
  recipients: ["admin@company.com"]
}
```

## ğŸ”— ç»Ÿä¸€çš„å†…éƒ¨APIè§„èŒƒ

### 1. ç»Ÿä¸€URLå‘½åè§„èŒƒ
```typescript
// åŸºç¡€CRUDæ“ä½œ
GET    /internal/{resource}                    // åˆ—è¡¨æŸ¥è¯¢
GET    /internal/{resource}/{id}               // å•ä¸ªæŸ¥è¯¢  
POST   /internal/{resource}                    // åˆ›å»ºèµ„æº
PUT    /internal/{resource}/{id}               // å®Œæ•´æ›´æ–°
PATCH  /internal/{resource}/{id}               // éƒ¨åˆ†æ›´æ–°
DELETE /internal/{resource}/{id}               // åˆ é™¤èµ„æº

// ä¸šåŠ¡æ“ä½œ
POST   /internal/{resource}/{id}/{action}      // ç‰¹å®šä¸šåŠ¡æ“ä½œ
GET    /internal/{resource}/{id}/{subresource} // å­èµ„æºæŸ¥è¯¢

// æ‰¹é‡æ“ä½œ
POST   /internal/{resource}/batch              // æ‰¹é‡åˆ›å»º
PUT    /internal/{resource}/batch              // æ‰¹é‡æ›´æ–°
POST   /internal/{resource}/batch-query        // æ‰¹é‡æŸ¥è¯¢

// éªŒè¯å’Œæ£€æŸ¥
POST   /internal/{resource}/validate           // æ•°æ®éªŒè¯
POST   /internal/{resource}/check              // çŠ¶æ€æ£€æŸ¥
POST   /internal/{resource}/exists             // å­˜åœ¨æ€§æ£€æŸ¥

// ç³»ç»Ÿæ“ä½œ
GET    /internal/health                        // å¥åº·æ£€æŸ¥
GET    /internal/metrics                       // æŒ‡æ ‡æ•°æ®
POST   /internal/events                        // äº‹ä»¶ä¸ŠæŠ¥
```

### 2. ç»Ÿä¸€è¯·æ±‚å¤´è§„èŒƒ
```typescript
interface StandardHeaders {
  'X-Service-Token': string        // å†…éƒ¨æœåŠ¡è®¤è¯ä»¤ç‰Œ (å¿…éœ€)
  'X-Service-Name': string         // è°ƒç”¨æ–¹æœåŠ¡åç§° (å¿…éœ€)
  'X-Request-ID': string           // è¯·æ±‚è¿½è¸ªID (å¿…éœ€)
  'X-Correlation-ID'?: string      // å…³è”ID (ä¸šåŠ¡æµç¨‹è¿½è¸ª)
  'X-User-Context'?: string        // ç”¨æˆ·ä¸Šä¸‹æ–‡ (Base64ç¼–ç çš„JSON)
  'X-Tenant-ID'?: string           // ç§Ÿæˆ·ID (å¤šç§Ÿæˆ·æ“ä½œ)
  'X-System-Token'?: string        // ç³»ç»Ÿçº§æ“ä½œä»¤ç‰Œ
  'Content-Type': 'application/json'
  'Accept': 'application/json'
}

// ç”¨æˆ·ä¸Šä¸‹æ–‡æ ¼å¼
interface UserContext {
  userId: string
  tenantId: string
  permissions: string[]
  roles: string[]
  sessionId?: string
}
```

### 3. ç»Ÿä¸€å“åº”æ ¼å¼
```typescript
// æˆåŠŸå“åº”
interface SuccessResponse<T> {
  success: true
  data: T
  meta?: {
    requestId: string
    timestamp: string
    duration: number      // å¤„ç†æ—¶é—´(ms)
    version: string       // APIç‰ˆæœ¬
  }
}

// é”™è¯¯å“åº”
interface ErrorResponse {
  success: false
  error: {
    code: string          // é”™è¯¯ä»£ç  (å¦‚: USER_NOT_FOUND)
    message: string       // é”™è¯¯æè¿°
    details?: any         // é”™è¯¯è¯¦æƒ…
    field?: string        // å­—æ®µé”™è¯¯(è¡¨å•éªŒè¯)
    requestId: string     // è¯·æ±‚ID
    timestamp: string     // é”™è¯¯æ—¶é—´
    service: string       // é”™è¯¯æ¥æºæœåŠ¡
    retryable: boolean    // æ˜¯å¦å¯é‡è¯•
  }
}

// åˆ†é¡µå“åº”
interface PaginatedResponse<T> {
  success: true
  data: T[]
  pagination: {
    page: number
    pageSize: number
    total: number
    totalPages: number
    hasNext: boolean
    hasPrev: boolean
  }
  meta: ResponseMeta
}
```

### 4. ç»Ÿä¸€é”™è¯¯ä»£ç è§„èŒƒ
```typescript
enum ServiceErrorCodes {
  // é€šç”¨é”™è¯¯ (1000-1999)
  INTERNAL_ERROR = 'INTERNAL_ERROR',
  INVALID_REQUEST = 'INVALID_REQUEST',
  UNAUTHORIZED = 'UNAUTHORIZED',
  FORBIDDEN = 'FORBIDDEN',
  NOT_FOUND = 'NOT_FOUND',
  RATE_LIMITED = 'RATE_LIMITED',
  SERVICE_UNAVAILABLE = 'SERVICE_UNAVAILABLE',
  TIMEOUT = 'TIMEOUT',
  
  // è®¤è¯ç›¸å…³ (2000-2099)
  INVALID_TOKEN = 'INVALID_TOKEN',
  TOKEN_EXPIRED = 'TOKEN_EXPIRED',
  INVALID_CREDENTIALS = 'INVALID_CREDENTIALS',
  ACCOUNT_LOCKED = 'ACCOUNT_LOCKED',
  MFA_REQUIRED = 'MFA_REQUIRED',
  
  // ç”¨æˆ·ç›¸å…³ (2100-2199)  
  USER_NOT_FOUND = 'USER_NOT_FOUND',
  USER_ALREADY_EXISTS = 'USER_ALREADY_EXISTS',
  USER_INACTIVE = 'USER_INACTIVE',
  USER_SUSPENDED = 'USER_SUSPENDED',
  
  // æƒé™ç›¸å…³ (2200-2299)
  PERMISSION_DENIED = 'PERMISSION_DENIED',
  ROLE_NOT_FOUND = 'ROLE_NOT_FOUND',
  INSUFFICIENT_PERMISSIONS = 'INSUFFICIENT_PERMISSIONS',
  
  // ç§Ÿæˆ·ç›¸å…³ (2300-2399)
  TENANT_NOT_FOUND = 'TENANT_NOT_FOUND',
  TENANT_QUOTA_EXCEEDED = 'TENANT_QUOTA_EXCEEDED',
  TENANT_SUSPENDED = 'TENANT_SUSPENDED',
  
  // æ–‡ä»¶ç›¸å…³ (2400-2499)
  FILE_NOT_FOUND = 'FILE_NOT_FOUND',
  FILE_TOO_LARGE = 'FILE_TOO_LARGE',
  INVALID_FILE_TYPE = 'INVALID_FILE_TYPE',
  STORAGE_QUOTA_EXCEEDED = 'STORAGE_QUOTA_EXCEEDED',
  
  // ç¼“å­˜ç›¸å…³ (2500-2599)
  CACHE_MISS = 'CACHE_MISS',
  CACHE_UNAVAILABLE = 'CACHE_UNAVAILABLE',
  
  // é˜Ÿåˆ—ç›¸å…³ (2600-2699)
  QUEUE_FULL = 'QUEUE_FULL',
  QUEUE_UNAVAILABLE = 'QUEUE_UNAVAILABLE',
  MESSAGE_PROCESSING_FAILED = 'MESSAGE_PROCESSING_FAILED'
}
```

## ğŸ”„ äº‹ä»¶é©±åŠ¨æ¶æ„è®¾è®¡

### 1. ç»Ÿä¸€äº‹ä»¶æ ¼å¼
```typescript
interface ServiceEvent {
  id: string                    // äº‹ä»¶ID
  type: string                  // äº‹ä»¶ç±»å‹ (å¦‚: user.created)
  version: string               // äº‹ä»¶ç‰ˆæœ¬
  timestamp: string             // äº‹ä»¶æ—¶é—´ (ISO 8601)
  source: string                // äº‹ä»¶æ¥æºæœåŠ¡
  tenantId?: string             // ç§Ÿæˆ·ID
  userId?: string               // ç”¨æˆ·ID
  correlationId?: string        // å…³è”ID
  causationId?: string          // å› æœID
  data: Record<string, any>     // äº‹ä»¶æ•°æ®
  metadata: {
    requestId?: string          // åŸå§‹è¯·æ±‚ID
    userAgent?: string          // ç”¨æˆ·ä»£ç†
    sourceIp?: string           // æºIP
    sessionId?: string          // ä¼šè¯ID
  }
}
```

### 2. äº‹ä»¶ç±»å‹å®šä¹‰
```typescript
// ç”¨æˆ·ç›¸å…³äº‹ä»¶
enum UserEvents {
  USER_CREATED = 'user.created',
  USER_UPDATED = 'user.updated',
  USER_DELETED = 'user.deleted',
  USER_ACTIVATED = 'user.activated',
  USER_SUSPENDED = 'user.suspended',
  USER_LOGIN = 'user.login',
  USER_LOGOUT = 'user.logout',
  USER_PASSWORD_CHANGED = 'user.password_changed'
}

// ç§Ÿæˆ·ç›¸å…³äº‹ä»¶
enum TenantEvents {
  TENANT_CREATED = 'tenant.created',
  TENANT_UPDATED = 'tenant.updated',
  TENANT_SUSPENDED = 'tenant.suspended',
  TENANT_QUOTA_EXCEEDED = 'tenant.quota_exceeded',
  TENANT_PLAN_CHANGED = 'tenant.plan_changed'
}

// æ–‡ä»¶ç›¸å…³äº‹ä»¶
enum FileEvents {
  FILE_UPLOADED = 'file.uploaded',
  FILE_DOWNLOADED = 'file.downloaded',
  FILE_DELETED = 'file.deleted',
  FILE_VIRUS_DETECTED = 'file.virus_detected',
  FILE_STORAGE_QUOTA_WARNING = 'file.quota_warning'
}

// ç³»ç»Ÿç›¸å…³äº‹ä»¶
enum SystemEvents {
  SERVICE_STARTED = 'system.service_started',
  SERVICE_STOPPED = 'system.service_stopped',
  SERVICE_HEALTH_CHANGED = 'system.health_changed',
  JOB_STARTED = 'system.job_started',
  JOB_COMPLETED = 'system.job_completed',
  JOB_FAILED = 'system.job_failed'
}
```

### 3. äº‹ä»¶è®¢é˜…æ¨¡å¼
```typescript
// å„æœåŠ¡çš„äº‹ä»¶è®¢é˜…å…³ç³»
const EVENT_SUBSCRIPTIONS = {
  'notification-service': [
    'user.created',           // å‘é€æ¬¢è¿é‚®ä»¶
    'user.password_changed',  // å‘é€å¯†ç å˜æ›´é€šçŸ¥
    'tenant.quota_exceeded',  // å‘é€é…é¢å‘Šè­¦
    'file.virus_detected',    // å‘é€å®‰å…¨å‘Šè­¦
    'system.job_failed'       // å‘é€ä»»åŠ¡å¤±è´¥å‘Šè­¦
  ],
  
  'audit-service': [
    'user.*',                 // è®°å½•æ‰€æœ‰ç”¨æˆ·ç›¸å…³æ“ä½œ
    'tenant.*',               // è®°å½•æ‰€æœ‰ç§Ÿæˆ·ç›¸å…³æ“ä½œ
    'file.*',                 // è®°å½•æ‰€æœ‰æ–‡ä»¶æ“ä½œ
    'system.*'                // è®°å½•æ‰€æœ‰ç³»ç»Ÿäº‹ä»¶
  ],
  
  'monitoring-service': [
    'user.login',             // æ›´æ–°ç™»å½•ç»Ÿè®¡
    'file.uploaded',          // æ›´æ–°å­˜å‚¨ç»Ÿè®¡
    'tenant.created',         // æ›´æ–°ç§Ÿæˆ·ç»Ÿè®¡
    'system.*'                // æ›´æ–°ç³»ç»ŸæŒ‡æ ‡
  ],
  
  'cache-service': [
    'user.updated',           // å¤±æ•ˆç”¨æˆ·ç¼“å­˜
    'user.deleted',           // æ¸…é™¤ç”¨æˆ·ç¼“å­˜
    'tenant.updated',         // å¤±æ•ˆç§Ÿæˆ·ç¼“å­˜
    'rbac.role_changed'       // å¤±æ•ˆæƒé™ç¼“å­˜
  ]
}
```

## ğŸ›¡ï¸ å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–

### 1. æœåŠ¡é—´è®¤è¯ä¸­é—´ä»¶
```typescript
@Injectable()
export class ServiceAuthGuard implements CanActivate {
  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest()
    const serviceToken = request.headers['x-service-token']
    const serviceName = request.headers['x-service-name']
    const requestId = request.headers['x-request-id']
    
    // éªŒè¯æœåŠ¡Token
    const isValidToken = await this.validateServiceToken(serviceToken, serviceName)
    if (!isValidToken) {
      throw new UnauthorizedException('Invalid service token')
    }
    
    // è®¾ç½®è¯·æ±‚ä¸Šä¸‹æ–‡
    request.serviceContext = {
      serviceName,
      requestId,
      timestamp: new Date().toISOString()
    }
    
    return true
  }
}
```

### 2. è¶…æ—¶å’Œé‡è¯•ç­–ç•¥
```typescript
interface ServiceCallConfig {
  service: string
  timeout: number
  retries: number
  retryDelay: number
  backoffMultiplier: number
  circuitBreakerThreshold: number
}

const SERVICE_CONFIGS: Record<string, ServiceCallConfig> = {
  'cache-service': {
    service: 'cache-service',
    timeout: 5000,       // 5ç§’è¶…æ—¶
    retries: 3,
    retryDelay: 100,     // 100msåˆå§‹å»¶è¿Ÿ
    backoffMultiplier: 2,
    circuitBreakerThreshold: 10
  },
  
  'auth-service': {
    service: 'auth-service', 
    timeout: 10000,      // 10ç§’è¶…æ—¶
    retries: 2,
    retryDelay: 200,
    backoffMultiplier: 2,
    circuitBreakerThreshold: 5
  },
  
  'notification-service': {
    service: 'notification-service',
    timeout: 30000,      // 30ç§’è¶…æ—¶
    retries: 1,          // é€šçŸ¥ç±»æœåŠ¡é‡è¯•æ¬¡æ•°å°‘
    retryDelay: 1000,
    backoffMultiplier: 1,
    circuitBreakerThreshold: 3
  }
}
```

### 3. é“¾è·¯è¿½è¸ªå’Œç›‘æ§
```typescript
// æ¯ä¸ªæœåŠ¡è°ƒç”¨éƒ½éœ€è¦ä¼ é€’è¿½è¸ªä¿¡æ¯
interface TraceContext {
  traceId: string        // é“¾è·¯è¿½è¸ªID
  spanId: string         // å½“å‰span ID
  parentSpanId?: string  // çˆ¶span ID
  flags: number          // è¿½è¸ªæ ‡è®°
  baggage?: Record<string, string> // é€ä¼ æ•°æ®
}

// æœåŠ¡è°ƒç”¨è£…é¥°å™¨
function TraceServiceCall(serviceName: string) {
  return function(target: any, propertyName: string, descriptor: PropertyDescriptor) {
    const method = descriptor.value
    descriptor.value = async function(...args: any[]) {
      const traceId = this.getTraceId()
      const spanId = generateSpanId()
      
      // å¼€å§‹span
      const span = tracer.startSpan(`${serviceName}.${propertyName}`, {
        parent: this.currentSpan,
        tags: {
          'service.name': serviceName,
          'operation.name': propertyName
        }
      })
      
      try {
        // æ‰§è¡ŒåŸæ–¹æ³•
        const result = await method.apply(this, args)
        span.setTag('success', true)
        return result
      } catch (error) {
        span.setTag('success', false)
        span.setTag('error', error.message)
        throw error
      } finally {
        span.finish()
      }
    }
  }
}
```

è¿™ä¸ªé‡æ–°è®¾è®¡çš„æ¶æ„è§£å†³äº†åŸæœ‰è§„èŒƒçš„æ‰€æœ‰é—®é¢˜ï¼Œæä¾›äº†ï¼š

1. **æ¸…æ™°çš„æœåŠ¡åˆ†å±‚** - æ˜ç¡®äº†è°ƒç”¨æ–¹å‘å’Œä¾èµ–å…³ç³»
2. **å®Œæ•´çš„ä¸šåŠ¡åœºæ™¯** - è¦†ç›–äº†å®é™…çš„ç«¯åˆ°ç«¯ä¸šåŠ¡æµç¨‹
3. **ç»Ÿä¸€çš„APIè§„èŒƒ** - æ ‡å‡†åŒ–äº†æ‰€æœ‰å†…éƒ¨APIçš„æ ¼å¼å’Œå‘½å
4. **äº‹ä»¶é©±åŠ¨æ¨¡å¼** - é€šè¿‡å¼‚æ­¥äº‹ä»¶å‡å°‘æœåŠ¡é—´è€¦åˆ
5. **ä¼ä¸šçº§å®‰å…¨** - å®Œæ•´çš„è®¤è¯ã€æˆæƒã€è¿½è¸ªæœºåˆ¶
6. **æ€§èƒ½ä¼˜åŒ–** - åˆ†å±‚çš„æ€§èƒ½è¦æ±‚å’Œé‡è¯•ç­–ç•¥

è¿™å°†ä¸º100ç§Ÿæˆ·+10ä¸‡ç”¨æˆ·çš„ä¼ä¸šçº§å¾®æœåŠ¡å¹³å°æä¾›åšå®çš„æ¶æ„åŸºç¡€ã€‚